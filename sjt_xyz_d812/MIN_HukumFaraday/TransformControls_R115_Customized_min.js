THREE.TransformControls=function(u,K){if(K===undefined){console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.');K=document}THREE.Object3D.call(this);this.visible=false;this.domElement=K;var f=new THREE.TransformControlsGizmo();this.add(f);var z=new THREE.TransformControlsPlane();this.add(z);var E=this;H("camera",u);H("object",undefined);H("enabled",true);H("axis",null);H("mode","translate");H("translationSnap",null);H("rotationSnap",null);H("scaleSnap",null);H("space","world");H("size",1);H("dragging",false);H("showX",true);H("showY",true);H("showZ",true);var S={type:"change"};var a={type:"mouseDown"};var i={type:"mouseUp",mode:E.mode};var V={type:"objectChange"};var Q=new THREE.Raycaster();var U=new THREE.Vector3();var s=new THREE.Vector3();var n=new THREE.Quaternion();var N={X:new THREE.Vector3(1,0,0),Y:new THREE.Vector3(0,1,0),Z:new THREE.Vector3(0,0,1)};var j=new THREE.Vector3();var P=new THREE.Vector3();var I=new THREE.Vector3();var h=new THREE.Vector3();var m=new THREE.Vector3();var x=new THREE.Vector3();var t=0;var o=new THREE.Vector3();var C=new THREE.Quaternion();var v=new THREE.Vector3();var G=new THREE.Vector3();var T=new THREE.Quaternion();var M=new THREE.Quaternion();var d=new THREE.Vector3();var W=new THREE.Vector3();var y=new THREE.Quaternion();var k=new THREE.Vector3();var q=new THREE.Vector3();var B=new THREE.Quaternion();var b=new THREE.Quaternion();var l=new THREE.Vector3();var J=new THREE.Vector3();var p=new THREE.Vector3();var g=new THREE.Quaternion();var r=new THREE.Vector3();H("worldPosition",q);H("worldPositionStart",W);H("worldQuaternion",B);H("worldQuaternionStart",y);H("cameraPosition",o);H("cameraQuaternion",C);H("pointStart",j);H("pointEnd",P);H("rotationAxis",h);H("rotationAngle",t);H("eye",J);K.addEventListener("mousedown",D,false);K.addEventListener("touchstart",D,false);K.addEventListener("mousemove",A,false);K.addEventListener("touchmove",A,false);K.addEventListener("touchmove",L,false);document.addEventListener("mouseup",F,false);K.addEventListener("touchend",F,false);K.addEventListener("touchcancel",F,false);K.addEventListener("touchleave",F,false);K.addEventListener("touchend",e);K.addEventListener("touchcancel",e);K.addEventListener("touchleave",e);var R=0;var c;var w=null;this.setAxis=function(X){w=X};this.dispose=function(){K.removeEventListener("mousedown",D);K.removeEventListener("touchstart",onPointerDownTTT);K.removeEventListener("mousemove",A);document.removeEventListener("mousemove",L);K.removeEventListener("touchmove",A);K.removeEventListener("touchmove",L);document.removeEventListener("mouseup",F);K.removeEventListener("touchend",F);K.removeEventListener("touchcancel",F);K.removeEventListener("touchleave",F);this.traverse(function(X){if(X.geometry){X.geometry.dispose()}if(X.material){X.material.dispose()}})};this.attach=function(X){this.object=X;this.visible=true;return this};this.detach=function(){this.object=undefined;this.visible=false;this.axis=null;return this};function H(Y,X){var Z=X;Object.defineProperty(E,Y,{get:function(){return Z!==undefined?Z:X},set:function(aa){if(Z!==aa){Z=aa;z[Y]=aa;f[Y]=aa;E.dispatchEvent({type:Y+"-changed",value:aa});E.dispatchEvent(S)}}});E[Y]=X;z[Y]=X;f[Y]=X}this.updateMatrixWorld=function(){if(this.object!==undefined){this.object.updateMatrixWorld();if(this.object.parent===null){console.error("TransformControls: The attached 3D object must be a part of the scene graph.")}else{this.object.parent.matrixWorld.decompose(G,T,d)}this.object.matrixWorld.decompose(q,B,l);M.copy(T).inverse();b.copy(B).inverse()}this.camera.updateMatrixWorld();this.camera.matrixWorld.decompose(o,C,v);J.copy(o).sub(q).normalize();THREE.Object3D.prototype.updateMatrixWorld.call(this)};this.pointerHover=function(Y){if(this.object===undefined||this.dragging===true||(Y.button!==undefined&&Y.button!==0)){return}if(w!=null){this.axis=w}else{Q.setFromCamera(Y,this.camera);var X=Q.intersectObjects(f.picker[this.mode].children,true)[0]||false;if(X){this.axis=X.object.name}else{this.axis=null}}};this.pointerDown=function(ab){if(event.type=="touchstart"){var Y={type:"click",index:this.index,data:{x:event.touches[0].clientX,y:event.touches[0].clientY}}}else{var Y={type:"click",index:this.index,data:{x:event.clientX,y:event.clientY}}}this.dispatchEvent(Y);this.axis=w;if(this.object===undefined||this.dragging===true||(ab.button!==undefined&&ab.button!==0)){return}if((ab.button===0||ab.button===undefined)&&this.axis!==null){Q.setFromCamera(ab,this.camera);z.updateMatrixWorld();var Z=Q.intersectObjects([z],true)[0]||false;if(Z){var aa=this.space;if(this.mode==="scale"){aa="local"}else{if(this.axis==="E"||this.axis==="XYZE"||this.axis==="XYZ"){aa="world"}}if(aa==="local"&&this.mode==="rotate"){var X=this.rotationSnap;if(this.axis==="X"&&X){this.object.rotation.x=Math.round(this.object.rotation.x/X)*X}if(this.axis==="Y"&&X){this.object.rotation.y=Math.round(this.object.rotation.y/X)*X}if(this.axis==="Z"&&X){this.object.rotation.z=Math.round(this.object.rotation.z/X)*X}}this.object.updateMatrixWorld();this.object.parent.updateMatrixWorld();p.copy(this.object.position);g.copy(this.object.quaternion);r.copy(this.object.scale);this.object.matrixWorld.decompose(W,y,k);j.copy(Z.point).sub(W)}this.dragging=true;a.mode=this.mode;this.dispatchEvent(a)}};this.pointerMove=function(ae){var aa=w;var ad=this.mode;var Z=this.object;var ab=this.space;if(ad==="scale"){ab="local"}else{if(aa==="E"||aa==="XYZE"||aa==="XYZ"){ab="world"}}if(Z===undefined||aa===null||this.dragging===false||(ae.button!==undefined&&ae.button!==0)){return}Q.setFromCamera(ae,this.camera);var Y=Q.intersectObjects([z],true)[0]||false;if(Y===false){return}P.copy(Y.point).sub(W);if(ad==="translate"){I.copy(P).sub(j);if(ab==="local"&&aa!=="XYZ"){I.applyQuaternion(b)}if(aa.indexOf("X")===-1){I.x=0}if(aa.indexOf("Y")===-1){I.y=0}if(aa.indexOf("Z")===-1){I.z=0}if(ab==="local"&&aa!=="XYZ"){I.applyQuaternion(g).divide(d)}else{I.applyQuaternion(M).divide(d)}Z.position.copy(I).add(p);if(this.translationSnap){if(ab==="local"){Z.position.applyQuaternion(n.copy(g).inverse());if(aa.search("X")!==-1){Z.position.x=Math.round(Z.position.x/this.translationSnap)*this.translationSnap}if(aa.search("Y")!==-1){Z.position.y=Math.round(Z.position.y/this.translationSnap)*this.translationSnap}if(aa.search("Z")!==-1){Z.position.z=Math.round(Z.position.z/this.translationSnap)*this.translationSnap}Z.position.applyQuaternion(g)}if(ab==="world"){if(Z.parent){Z.position.add(U.setFromMatrixPosition(Z.parent.matrixWorld))}if(aa.search("X")!==-1){Z.position.x=Math.round(Z.position.x/this.translationSnap)*this.translationSnap}if(aa.search("Y")!==-1){Z.position.y=Math.round(Z.position.y/this.translationSnap)*this.translationSnap}if(aa.search("Z")!==-1){Z.position.z=Math.round(Z.position.z/this.translationSnap)*this.translationSnap}if(Z.parent){Z.position.sub(U.setFromMatrixPosition(Z.parent.matrixWorld))}}}}else{if(ad==="scale"){if(aa.search("XYZ")!==-1){var ac=P.length()/j.length();if(P.dot(j)<0){ac*=-1}s.set(ac,ac,ac)}else{U.copy(j);s.copy(P);U.applyQuaternion(b);s.applyQuaternion(b);s.divide(U);if(aa.search("X")===-1){s.x=1}if(aa.search("Y")===-1){s.y=1}if(aa.search("Z")===-1){s.z=1}}Z.scale.copy(r).multiply(s);if(this.scaleSnap){if(aa.search("X")!==-1){Z.scale.x=Math.round(Z.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap}if(aa.search("Y")!==-1){Z.scale.y=Math.round(Z.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap}if(aa.search("Z")!==-1){Z.scale.z=Math.round(Z.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap}}}else{if(ad==="rotate"){I.copy(P).sub(j);var X=20/q.distanceTo(U.setFromMatrixPosition(this.camera.matrixWorld));if(aa==="E"){h.copy(J);t=P.angleTo(j);m.copy(j).normalize();x.copy(P).normalize();t*=(x.cross(m).dot(J)<0?1:-1)}else{if(aa==="XYZE"){h.copy(I).cross(J).normalize();t=I.dot(U.copy(h).cross(this.eye))*X}else{if(aa==="X"||aa==="Y"||aa==="Z"){h.copy(N[aa]);U.copy(N[aa]);if(ab==="local"){U.applyQuaternion(B)}t=I.dot(U.cross(J).normalize())*X}}}if(this.rotationSnap){t=Math.round(t/this.rotationSnap)*this.rotationSnap}this.rotationAngle=t;if(ab==="local"&&aa!=="E"&&aa!=="XYZE"){Z.quaternion.copy(g);Z.quaternion.multiply(n.setFromAxisAngle(h,t)).normalize()}else{h.applyQuaternion(M);Z.quaternion.copy(n.setFromAxisAngle(h,t));Z.quaternion.multiply(g).normalize()}}}}this.dispatchEvent(S);this.dispatchEvent(V)};this.pointerUp=function(X){if(X.button!==undefined&&X.button!==0){return}if(this.dragging&&(this.axis!==null)){i.mode=this.mode;this.dispatchEvent(i)}this.dragging=false;if(X.button===undefined){this.axis=null}w=null};function O(Y){if(document.pointerLockElement){return{x:0,y:0,button:Y.button}}else{var Z=Y.changedTouches?Y.changedTouches[0]:Y;var X=K.getBoundingClientRect();return{x:(Z.clientX-X.left)/X.width*2-1,y:-(Z.clientY-X.top)/X.height*2+1,button:Y.button}}}function A(X){if(!E.enabled){return}E.pointerHover(O(X))}function D(X){if(X.type=="touchstart"){R++;if(R>1){return}}if(X.type=="touchstart"){c=X.changedTouches[0].identifier}if(!E.enabled){return}document.addEventListener("mousemove",L,false);E.pointerHover(O(X));E.pointerDown(O(X))}function L(X){if(X.type=="touchmove"){console.log("id=",X.changedTouches[0].identifier,"  finger id=",c)}if(X.type=="touchmove"&&X.changedTouches[0].identifier!=c){return}if(!E.enabled){return}E.pointerMove(O(X))}function F(X){if(X.type=="touchend"&&X.changedTouches[0].identifier!=c){return}if(!E.enabled){return}document.removeEventListener("mousemove",L,false);E.pointerUp(O(X))}function e(X){if(R>0){R--}}this.getMode=function(){return E.mode};this.setMode=function(X){E.mode=X};this.setTranslationSnap=function(X){E.translationSnap=X};this.setRotationSnap=function(X){E.rotationSnap=X};this.setScaleSnap=function(X){E.scaleSnap=X};this.setSize=function(X){E.size=X};this.setSpace=function(X){E.space=X};this.update=function(){console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}};THREE.TransformControls.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:THREE.TransformControls,isTransformControls:true});THREE.TransformControlsGizmo=function(){THREE.Object3D.call(this);this.type="TransformControlsGizmo";var n=new THREE.MeshBasicMaterial({depthTest:false,depthWrite:false,transparent:true,side:THREE.DoubleSide,fog:false});var b=new THREE.LineBasicMaterial({depthTest:false,depthWrite:false,transparent:true,linewidth:1,fog:false});var q=n.clone();q.opacity=0.15;var a=n.clone();a.opacity=0;var K=n.clone();K.color.set(16711680);var k=n.clone();k.color.set(65280);var Q=n.clone();Q.color.set(255);var h=n.clone();h.opacity=0.25;var u=h.clone();u.color.set(16776960);var S=h.clone();S.color.set(65535);var E=h.clone();E.color.set(16711935);var T=n.clone();T.color.set(16776960);var m=b.clone();m.color.set(16711680);var D=b.clone();D.color.set(65280);var L=b.clone();L.color.set(255);var f=b.clone();f.color.set(65535);var C=b.clone();C.color.set(16711935);var p=b.clone();p.color.set(16776960);var x=b.clone();x.color.set(7895160);var j=p.clone();j.opacity=0.25;var H=new THREE.CylinderBufferGeometry(0,0.05,0.2,12,1,false);var v=new THREE.BoxBufferGeometry(0.125,0.125,0.125);var F=new THREE.BufferGeometry();F.setAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var t=function(U,X){var Y=new THREE.BufferGeometry();var V=[];for(var W=0;W<=64*X;++W){V.push(0,Math.cos(W/32*Math.PI)*U,Math.sin(W/32*Math.PI)*U)}Y.setAttribute("position",new THREE.Float32BufferAttribute(V,3));return Y};var o=function(){var U=new THREE.BufferGeometry();U.setAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,1,1],3));return U};var z={X:[[new THREE.Mesh(H,K),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new THREE.Mesh(H,K),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new THREE.Line(F,m)]],Y:[[new THREE.Mesh(H,k),[0,1,0],null,null,"fwd"],[new THREE.Mesh(H,k),[0,1,0],[Math.PI,0,0],null,"bwd"],[new THREE.Line(F,D),null,[0,0,Math.PI/2]]],Z:[],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(0.1,0),h.clone()),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(0.295,0.295),u.clone()),[0.15,0.15,0]],[new THREE.Line(F,p),[0.18,0.3,0],null,[0.125,1,1]],[new THREE.Line(F,p),[0.3,0.18,0],[0,0,Math.PI/2],[0.125,1,1]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(0.295,0.295),S.clone()),[0,0.15,0.15],[0,Math.PI/2,0]],[new THREE.Line(F,f),[0,0.18,0.3],[0,0,Math.PI/2],[0.125,1,1]],[new THREE.Line(F,f),[0,0.3,0.18],[0,-Math.PI/2,0],[0.125,1,1]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(0.295,0.295),E.clone()),[0.15,0,0.15],[-Math.PI/2,0,0]],[new THREE.Line(F,C),[0.18,0,0.3],null,[0.125,1,1]],[new THREE.Line(F,C),[0.3,0,0.18],[0,-Math.PI/2,0],[0.125,1,1]]]};var r={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(0.2,0,1,4,1,false),q),[0.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(0.2,0,1,4,1,false),q),[0,0.6,0]]],Z:[],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(0.2,0),q)]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(0.4,0.4),q),[0.2,0.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(0.4,0.4),q),[0,0.2,0.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(0.4,0.4),q),[0.2,0,0.2],[-Math.PI/2,0,0]]]};var y={START:[],END:[],DELTA:[],X:[[new THREE.Line(F,a.clone()),[-1000,0,0],null,[1000000,1,1],"helper"]],Y:[[new THREE.Line(F,a.clone()),[0,-1000,0],[0,0,Math.PI/2],[1000000,1,1],"helper"]],Z:[[new THREE.Line(F,a.clone()),[0,0,-1000],[0,-Math.PI/2,0],[1000000,1,1],"helper"]]};var R={X:[[new THREE.Line(t(1,0.5),m)],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(0.04,0),K),[0,0,0.99],null,[1,3,1]]],Y:[[new THREE.Line(t(1,0.5),D),null,[0,0,-Math.PI/2]],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(0.04,0),k),[0,0,0.99],null,[3,1,1]]],Z:[],E:[[new THREE.Line(t(1.25,1),j),null,[0,Math.PI/2,0]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(0.03,0,0.15,4,1,false),j),[1.17,0,0],[0,0,-Math.PI/2],[1,1,0.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(0.03,0,0.15,4,1,false),j),[-1.17,0,0],[0,0,Math.PI/2],[1,1,0.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(0.03,0,0.15,4,1,false),j),[0,-1.17,0],[Math.PI,0,0],[1,1,0.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(0.03,0,0.15,4,1,false),j),[0,1.17,0],[0,0,0],[1,1,0.001]]],XYZE:[[new THREE.Line(t(1,1),x),null,[0,Math.PI/2,0]]]};var N={AXIS:[[new THREE.Line(F,a.clone()),[-1000,0,0],null,[1000000,1,1],"helper"]]};var P={X:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,0.1,4,24),q),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,0.1,4,24),q),[0,0,0],[Math.PI/2,0,0]]],Z:[],E:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1.25,0.1,2,24),q)]],XYZE:[[new THREE.Mesh(new THREE.SphereBufferGeometry(0.7,10,8),q)]]};var A={X:[[new THREE.Mesh(v,K),[0.8,0,0],[0,0,-Math.PI/2]],[new THREE.Line(F,m),null,null,[0.8,1,1]]],Y:[[new THREE.Mesh(v,k),[0,0.8,0]],[new THREE.Line(F,D),null,[0,0,Math.PI/2],[0.8,1,1]]],Z:[],XY:[[new THREE.Mesh(v,u),[0.85,0.85,0],null,[2,2,0.2]],[new THREE.Line(F,p),[0.855,0.98,0],null,[0.125,1,1]],[new THREE.Line(F,p),[0.98,0.855,0],[0,0,Math.PI/2],[0.125,1,1]]],YZ:[[new THREE.Mesh(v,S),[0,0.85,0.85],null,[0.2,2,2]],[new THREE.Line(F,f),[0,0.855,0.98],[0,0,Math.PI/2],[0.125,1,1]],[new THREE.Line(F,f),[0,0.98,0.855],[0,-Math.PI/2,0],[0.125,1,1]]],XZ:[[new THREE.Mesh(v,E),[0.85,0,0.85],null,[2,0.2,2]],[new THREE.Line(F,C),[0.855,0,0.98],null,[0.125,1,1]],[new THREE.Line(F,C),[0.98,0,0.855],[0,-Math.PI/2,0],[0.125,1,1]]],XYZX:[[new THREE.Mesh(new THREE.BoxBufferGeometry(0.125,0.125,0.125),h.clone()),[1.1,0,0]]],XYZY:[[new THREE.Mesh(new THREE.BoxBufferGeometry(0.125,0.125,0.125),h.clone()),[0,1.1,0]]],XYZZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(0.125,0.125,0.125),h.clone()),[0,0,1.1]]]};var G={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(0.2,0,0.8,4,1,false),q),[0.5,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(0.2,0,0.8,4,1,false),q),[0,0.5,0]]],Z:[],XY:[[new THREE.Mesh(v,q),[0.85,0.85,0],null,[3,3,0.2]]],YZ:[[new THREE.Mesh(v,q),[0,0.85,0.85],null,[0.2,3,3]]],XZ:[[new THREE.Mesh(v,q),[0.85,0,0.85],null,[3,0.2,3]]],XYZX:[[new THREE.Mesh(new THREE.BoxBufferGeometry(0.2,0.2,0.2),q),[1.1,0,0]]],XYZY:[[new THREE.Mesh(new THREE.BoxBufferGeometry(0.2,0.2,0.2),q),[0,1.1,0]]],XYZZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(0.2,0.2,0.2),q),[0,0,1.1]]]};var B={X:[],Y:[],Z:[]};var O=function(ab){var Y=new THREE.Object3D();for(var U in ab){for(var Z=ab[U].length;Z--;){var X=ab[U][Z][0].clone();var aa=ab[U][Z][1];var ac=ab[U][Z][2];var W=ab[U][Z][3];var ad=ab[U][Z][4];X.name=U;X.tag=ad;if(aa){X.position.set(aa[0],aa[1],aa[2])}if(ac){X.rotation.set(ac[0],ac[1],ac[2])}if(W){X.scale.set(W[0],W[1],W[2])}X.updateMatrix();var V=X.geometry.clone();V.applyMatrix4(X.matrix);X.geometry=V;X.renderOrder=Infinity;X.position.set(0,0,0);X.rotation.set(0,0,0);X.scale.set(1,1,1);Y.add(X)}}return Y};var w=new THREE.Vector3(0,0,0);var M=new THREE.Euler();var s=new THREE.Vector3(0,1,0);var c=new THREE.Vector3(0,0,0);var I=new THREE.Matrix4();var d=new THREE.Quaternion();var l=new THREE.Quaternion();var J=new THREE.Quaternion();var i=new THREE.Vector3(1,0,0);var g=new THREE.Vector3(0,1,0);var e=new THREE.Vector3(0,0,1);this.gizmo={};this.picker={};this.helper={};this.add(this.gizmo.translate=O(z));this.add(this.gizmo.rotate=O(R));this.add(this.gizmo.scale=O(A));this.add(this.picker.translate=O(r));this.add(this.picker.rotate=O(P));this.add(this.picker.scale=O(G));this.add(this.helper.translate=O(y));this.add(this.helper.rotate=O(N));this.add(this.helper.scale=O(B));this.picker.translate.visible=false;this.picker.rotate.visible=false;this.picker.scale.visible=false;this.updateMatrixWorld=function(){var U=this.space;if(this.mode==="scale"){U="local"}var V=U==="local"?this.worldQuaternion:J;this.gizmo.translate.visible=this.mode==="translate";this.gizmo.rotate.visible=this.mode==="rotate";this.gizmo.scale.visible=this.mode==="scale";this.helper.translate.visible=this.mode==="translate";this.helper.rotate.visible=this.mode==="rotate";this.helper.scale.visible=this.mode==="scale";var aa=[];aa=aa.concat(this.picker[this.mode].children);aa=aa.concat(this.gizmo[this.mode].children);aa=aa.concat(this.helper[this.mode].children);for(var W=0;W<aa.length;W++){var X=aa[W];X.visible=true;X.rotation.set(0,0,0);X.position.copy(this.worldPosition);var Y=this.worldPosition.distanceTo(this.cameraPosition);X.scale.set(1,1,1).multiplyScalar(Y*this.size/7);if(X.tag==="helper"){X.visible=false;if(X.name==="AXIS"){X.position.copy(this.worldPositionStart);X.visible=!!this.axis;if(this.axis==="X"){d.setFromEuler(M.set(0,0,0));X.quaternion.copy(V).multiply(d);if(Math.abs(s.copy(i).applyQuaternion(V).dot(this.eye))>0.9){X.visible=false}}if(this.axis==="Y"){d.setFromEuler(M.set(0,0,Math.PI/2));X.quaternion.copy(V).multiply(d);if(Math.abs(s.copy(g).applyQuaternion(V).dot(this.eye))>0.9){X.visible=false}}if(this.axis==="Z"){d.setFromEuler(M.set(0,Math.PI/2,0));X.quaternion.copy(V).multiply(d);if(Math.abs(s.copy(e).applyQuaternion(V).dot(this.eye))>0.9){X.visible=false}}if(this.axis==="XYZE"){d.setFromEuler(M.set(0,Math.PI/2,0));s.copy(this.rotationAxis);X.quaternion.setFromRotationMatrix(I.lookAt(c,s,g));X.quaternion.multiply(d);X.visible=this.dragging}if(this.axis==="E"){X.visible=false}}else{if(X.name==="START"){X.position.copy(this.worldPositionStart);X.visible=this.dragging}else{if(X.name==="END"){X.position.copy(this.worldPosition);X.visible=this.dragging}else{if(X.name==="DELTA"){X.position.copy(this.worldPositionStart);X.quaternion.copy(this.worldQuaternionStart);w.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1);w.applyQuaternion(this.worldQuaternionStart.clone().inverse());X.scale.copy(w);X.visible=this.dragging}else{X.quaternion.copy(V);if(this.dragging){X.position.copy(this.worldPositionStart)}else{X.position.copy(this.worldPosition)}if(this.axis){X.visible=this.axis.search(X.name)!==-1}}}}}continue}X.quaternion.copy(V);if(this.mode==="translate"||this.mode==="scale"){var ac=0.99;var ab=0.2;var Z=0;if(X.name==="X"||X.name==="XYZX"){if(Math.abs(s.copy(i).applyQuaternion(V).dot(this.eye))>ac){X.scale.set(1e-10,1e-10,1e-10);X.visible=false}}if(X.name==="Y"||X.name==="XYZY"){if(Math.abs(s.copy(g).applyQuaternion(V).dot(this.eye))>ac){X.scale.set(1e-10,1e-10,1e-10);X.visible=false}}if(X.name==="Z"||X.name==="XYZZ"){if(Math.abs(s.copy(e).applyQuaternion(V).dot(this.eye))>ac){X.scale.set(1e-10,1e-10,1e-10);X.visible=false}}if(X.name==="XY"){if(Math.abs(s.copy(e).applyQuaternion(V).dot(this.eye))<ab){X.scale.set(1e-10,1e-10,1e-10);X.visible=false}}if(X.name==="YZ"){if(Math.abs(s.copy(i).applyQuaternion(V).dot(this.eye))<ab){X.scale.set(1e-10,1e-10,1e-10);X.visible=false}}if(X.name==="XZ"){if(Math.abs(s.copy(g).applyQuaternion(V).dot(this.eye))<ab){X.scale.set(1e-10,1e-10,1e-10);X.visible=false}}if(X.name.search("X")!==-1){if(s.copy(i).applyQuaternion(V).dot(this.eye)<Z){if(X.tag==="fwd"){X.visible=false}else{X.scale.x*=-1}}else{if(X.tag==="bwd"){X.visible=false}}}if(X.name.search("Y")!==-1){if(s.copy(g).applyQuaternion(V).dot(this.eye)<Z){if(X.tag==="fwd"){X.visible=false}else{X.scale.y*=-1}}else{if(X.tag==="bwd"){X.visible=false}}}if(X.name.search("Z")!==-1){if(s.copy(e).applyQuaternion(V).dot(this.eye)<Z){if(X.tag==="fwd"){X.visible=false}else{X.scale.z*=-1}}else{if(X.tag==="bwd"){X.visible=false}}}}else{if(this.mode==="rotate"){l.copy(V);s.copy(this.eye).applyQuaternion(d.copy(V).inverse());if(X.name.search("E")!==-1){X.quaternion.setFromRotationMatrix(I.lookAt(this.eye,c,g))}if(X.name==="X"){d.setFromAxisAngle(i,Math.atan2(-s.y,s.z));d.multiplyQuaternions(l,d);X.quaternion.copy(d)}if(X.name==="Y"){d.setFromAxisAngle(g,Math.atan2(s.x,s.z));d.multiplyQuaternions(l,d);X.quaternion.copy(d)}if(X.name==="Z"){d.setFromAxisAngle(e,Math.atan2(s.y,s.x));d.multiplyQuaternions(l,d);X.quaternion.copy(d)}}}X.visible=X.visible&&(X.name.indexOf("X")===-1||this.showX);X.visible=X.visible&&(X.name.indexOf("Y")===-1||this.showY);X.visible=X.visible&&(X.name.indexOf("Z")===-1||this.showZ);X.visible=X.visible&&(X.name.indexOf("E")===-1||(this.showX&&this.showY&&this.showZ));X.material._opacity=X.material._opacity||X.material.opacity;X.material._color=X.material._color||X.material.color.clone();X.material.color.copy(X.material._color);X.material.opacity=X.material._opacity;if(!this.enabled){X.material.opacity*=0.5;X.material.color.lerp(new THREE.Color(1,1,1),0.5)}else{if(this.axis){if(X.name===this.axis){X.material.opacity=1;X.material.color.lerp(new THREE.Color(1,1,1),0.5)}else{if(this.axis.split("").some(function(ad){return X.name===ad})){X.material.opacity=1;X.material.color.lerp(new THREE.Color(1,1,1),0.5)}else{X.material.opacity*=0.25;X.material.color.lerp(new THREE.Color(1,1,1),0.5)}}}}}THREE.Object3D.prototype.updateMatrixWorld.call(this)}};THREE.TransformControlsGizmo.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:THREE.TransformControlsGizmo,isTransformControlsGizmo:true});THREE.TransformControlsPlane=function(){THREE.Mesh.call(this,new THREE.PlaneBufferGeometry(100000,100000,2,2),new THREE.MeshBasicMaterial({visible:false,wireframe:true,side:THREE.DoubleSide,transparent:true,opacity:0.1}));this.type="TransformControlsPlane";var h=new THREE.Vector3(1,0,0);var g=new THREE.Vector3(0,1,0);var f=new THREE.Vector3(0,0,1);var a=new THREE.Vector3();var e=new THREE.Vector3();var d=new THREE.Vector3();var c=new THREE.Matrix4();var b=new THREE.Quaternion();this.updateMatrixWorld=function(){var i=this.space;this.position.copy(this.worldPosition);if(this.mode==="scale"){i="local"}h.set(1,0,0).applyQuaternion(i==="local"?this.worldQuaternion:b);g.set(0,1,0).applyQuaternion(i==="local"?this.worldQuaternion:b);f.set(0,0,1).applyQuaternion(i==="local"?this.worldQuaternion:b);d.copy(g);switch(this.mode){case"translate":case"scale":switch(this.axis){case"X":d.copy(this.eye).cross(h);e.copy(h).cross(d);break;case"Y":d.copy(this.eye).cross(g);e.copy(g).cross(d);break;case"Z":d.copy(this.eye).cross(f);e.copy(f).cross(d);break;case"XY":e.copy(f);break;case"YZ":e.copy(h);break;case"XZ":d.copy(f);e.copy(g);break;case"XYZ":case"E":e.set(0,0,0);break}break;case"rotate":default:e.set(0,0,0)}if(e.length()===0){this.quaternion.copy(this.cameraQuaternion)}else{c.lookAt(a.set(0,0,0),e,d);this.quaternion.setFromRotationMatrix(c)}THREE.Object3D.prototype.updateMatrixWorld.call(this)}};THREE.TransformControlsPlane.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:THREE.TransformControlsPlane,isTransformControlsPlane:true});